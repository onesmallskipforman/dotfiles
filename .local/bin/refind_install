#!/bin/sh

# install rEFInd boot manager

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until the script has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

# Folders
DATA="$HOME/.local/share/refind"
CONFIG="$HOME/.config/refind"
REFDIR="/Volumes/ESP/EFI/refind"

# if not installed or forced, run install prep
mkdir -p $DATA
rm -rf $DATA/refind-bin*
wget --hsts-file="$XDG_CACHE_HOME/wget-hsts" -O $DATA/refind.zip \
  https://sourceforge.net/projects/refind/files/latest/download
unzip $DATA/refind.zip -d $DATA/
rm $DATA/refind.zip
sudo $DATA/refind-bin*/mountesp
rm -rf "$REFDIR"

# install/upgrade
sudo $DATA/refind-bin*/refind-install

# clean upgrade contents, copy refind.conf
rm -f  "$REFDIR/refind.conf-sample"
rm -rf "$REFDIR/icons-backup"
cp     "$CONFIG/refind.conf" "$REFDIR/refind.conf"

# install themes
TURL="https://github.com/bobafetthotmail/refind-theme-regular.git"  # refind theme regular
# TURL="https://github.com/kgoettler/ursamajor-rEFInd.git"            # major theme
# TURL="https://github.com/andersfischernielsen/rEFInd-minimal-black" # minimalist black theme
# TURL="https://github.com/htower/refind-theme-regular-black"         # refind theme regular black

TDIR="themes/$(basename $TURL .git)"
mkdir -p "$REFDIR/$TDIR"
git clone "$TURL" "$REFDIR/$TDIR"
echo "include $TDIR/theme.conf" >> "$REFDIR/refind.conf"
cp "$CONFIG/theme.conf" "$REFDIR/$TDIR/theme.conf"

# unmount ESP/EFI
sudo diskutil unmount /Volumes/ESP
