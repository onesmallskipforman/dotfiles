#!/bin/sh

# set xrandr/xdpyinfo dpi based on xrandr dimensions
# TODO: determine if this is needed or if xrandr will figure out dpi on its own
# i suspect it won't for HiDPI
xrandr | grep -w connected | grep -o '[0-9]\+mm' | sed 's/mm//g' |  paste -sd 'x' - | xargs xrandr --fbmm

# load X resources
[ -f $XDG_CONFIG_HOME/x11/Xresources ] \
  && { xrdb -merge -I$HOME $XDG_CONFIG_HOME/x11/Xresources; }

# ensure xresources is aligned with xrandr/xdpyinfo
xdpyinfo \
  | grep resolution \
  | grep -o '[0-9]\+x' \
  | sed 's/x//g;s/^/Xft.dpi: /g' \
  | xrdb -merge -;

xrdb -merge ~/.cache/wal/colors.Xresources

# based on /etc/X11/Xsession.d/20dbus_xdg-runtime in ubuntu desktop
DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
dbus-update-activation-environment --verbose --systemd \
  DBUS_SESSION_BUS_ADDRESS DISPLAY XAUTHORITY

# set natural scrolling
xinput list --id-only | xargs -n1 -I{} xinput --set-prop {} "libinput Natural Scrolling Enabled" 1 &>/dev/null

# set mouse speed and acceleration
# TODO: fix
xinput set-prop 'Logitech M510' "libinput Accel Speed" -0.2
#xinput list --id-only | xargs -n1 -I{} xinput --set-prop {} "libinput Accel Speed" -0.60 &>/dev/null
#xinput list --id-only | xargs -n1 -I{} xinput --set-prop {} "libinput Accel Profile Enabled" 1,0 &>/dev/null
#xset m 3/1 0

# set key repeat relay (225 ms) and repeat time (30 ms -> ~33/s)
# TODO: adjust
xset r rate 225 33

# start redshift
[ -x "$(command -v redshift)" ] && redshift &

# set cursor
xsetroot -cursor_name left_ptr

# set wallpaper
# feh --bg-fill ~/Downloads/torc_robotics_bg_black_1920x1080.v1.png
feh --bg-fill $HOME/.local/share/wallpapers/beams.jpeg

# feh --bg-fill ~/Documents/whatsapp.jpg
# feh --bg-fill ~/Projects/userdata/wallpapers/beams.jpeg

# start window compositor
[ -x "$(command -v picom)" ] && picom --config ~/.config/picom/picom.conf &

# sleep 1

# start polybar
[ -x "$(command -v polybar)" ] && ~/.config/polybar/launch.sh &

# xset s 300 5
# xss-lock -n /usr/lib/xsecurelock/dimmer -l -- /home/skipper/xsecurelock.sh

# start window manager
sxhkd &
exec bspwm
